---
title: "Kubernetes Storage 101: å¼•å…¥åŠ¨æ€æŒ‚è½½å·ï¼Œå®ç°å·¥ä½œè´Ÿè½½è¿è¡Œæ—¶çš„å­˜å‚¨çµæ´»æ€§(ä¸‹)"
description: "ä¸€ç§åŸºäº Kubernetes Operator æ¨¡å¼å’Œ CSI Driver çš„åŠ¨æ€å­˜å‚¨æŒ‚è½½æ–¹æ¡ˆï¼Œé€šè¿‡è‡ªå®šä¹‰èµ„æºå®ç°å·¥ä½œè´Ÿè½½è¿è¡Œæ—¶å­˜å‚¨çš„çµæ´»æ·»åŠ å’Œç§»é™¤ï¼Œä½“ç°äº‘åŸç”Ÿå­˜å‚¨ç®¡ç†çš„åˆ›æ–°ç†å¿µã€‚"
date: 2024-11-27T14:44:45+08:00
draft: false
author: LQ
toc: true
categories:
- cloud-native
tags:
- Kubernetes Storage 101
- Kubernetes
---

![cover](https://cdn.jsdelivr.net/gh/cloud-native-101/files@main/imgs/kubernetes-storage-101-dynamic-volume-mounting-runtime-flexibility/a179d8b5-4c28-47ac-bf45-4ece2e7f3e09.webp)

åœ¨ä¸Šä¸€ç¯‡æ–‡ç« [ã€ŠKubernetes Storage 101: å¼•å…¥åŠ¨æ€æŒ‚è½½å·ï¼Œå®ç°å·¥ä½œè´Ÿè½½è¿è¡Œæ—¶çš„å­˜å‚¨çµæ´»æ€§(ä¸Š)ã€‹](https://mp.weixin.qq.com/s/kDPEl65SK_6X-LRLi6tn1A) ä¸­ï¼Œæˆ‘ä»¬æ¢ç´¢äº†å¦‚ä½•åœ¨ Kubernetes Pod ä¸­ä¸ºè¿è¡Œä¸­çš„å®ä¾‹åŠ¨æ€çš„æ·»åŠ æˆ–ç§»é™¤å­˜å‚¨èµ„æºã€‚ç„¶è€Œï¼Œè¿™ç§æ–¹æ³•ä»…é€‚ç”¨äº Pod ç±»å‹çš„å·¥ä½œè´Ÿè½½ï¼Œç¼ºä¹å¯¹ Kubernetes ä¸­å…¶ä»–ç±»å‹å·¥ä½œè´Ÿè½½çš„æ”¯æŒã€‚æ­¤å¤–ï¼Œå®ƒé€šè¿‡ `gRPC` æœåŠ¡æ¥æš´éœ²åŠŸèƒ½ï¼Œè¿™ä¸ Kubernetes çš„å£°æ˜å¼ç®¡ç†æ¨¡å¼ç›¸æ‚–ã€‚

{{< article link="/posts/kubernetes-storage-101-dynamic-volume-mounting-runtime-flexibility-part-1/" >}}

å› æ­¤ï¼Œæœ¬ç¯‡æ–‡ç« å°†æ·±å…¥æ¢è®¨å¦‚ä½•åˆ©ç”¨ Kubernetes çš„ Operator æ¨¡å¼ï¼Œè®¾è®¡ä¸€ä¸ªé€šç”¨ä¸”ç¬¦åˆäº‘åŸç”Ÿç†å¿µçš„åŠ¨æ€å­˜å‚¨æŒ‚è½½æ–¹æ¡ˆï¼Œçªç ´ä¼ ç»Ÿæ–¹æ³•çš„å±€é™ã€‚

## ä»å£°æ˜å¼ç®¡ç†æ¨¡å¼è¯´èµ·

åœ¨äº‘åŸç”Ÿçš„ä¸–ç•Œé‡Œï¼ŒKubernetes çš„å£°æ˜å¼ç®¡ç†å°±åƒæ˜¯ä¸€ä¸ªæ™ºèƒ½çš„"çŠ¶æ€åè°ƒå™¨"ã€‚

ä¸¾ä¸ªç®€å•çš„ä¾‹å­ï¼Œå¦‚æœæˆ‘ä»¬æƒ³æ‰©å®¹ä¸€ä¸ª Deploymentï¼Œåªéœ€ä¿®æ”¹å…¶ YAML é…ç½®ä¸­çš„ `spec.replicas` å­—æ®µï¼Œç„¶å `kubectl apply`ï¼ŒKubernetes å°±ä¼šè‡ªåŠ¨å°†å½“å‰çŠ¶æ€è°ƒæ•´åˆ°æˆ‘ä»¬æœŸæœ›çš„çŠ¶æ€ã€‚

åŒæ ·åœ°ï¼Œåœ¨å®é™…åº”ç”¨ä¸­ï¼Œæˆ‘ä»¬ç»å¸¸éœ€è¦ä¸ºå·¥ä½œè´Ÿè½½æ·»åŠ é¢å¤–çš„é…ç½®ï¼Œä¾‹å¦‚ä¸º Pod å¢åŠ  Sidecar å®¹å™¨ï¼Œæˆ–è€…è¿½åŠ æ–°çš„ Volumeã€‚è¿™äº›æ“ä½œéƒ½å¯ä»¥é€šè¿‡ä¿®æ”¹èµ„æºçš„å£°æ˜å¼é…ç½®æ¥å®Œæˆï¼Œæ—¢ç›´è§‚åˆé«˜æ•ˆã€‚

æˆ‘ä»¬çš„åŠ¨æ€å­˜å‚¨æŒ‚è½½æ–¹æ¡ˆå°†å»¶ç»­è¿™ä¸€ç†å¿µã€‚

### å¼•å…¥è‡ªå®šä¹‰èµ„æºå®šä¹‰ï¼ˆCRDï¼‰

é€šè¿‡è‡ªå®šä¹‰èµ„æºï¼Œæˆ‘ä»¬å¯ä»¥æ‰©å±• Kubernetes çš„å­˜å‚¨ç®¡ç†èƒ½åŠ›ã€‚

ä¾‹å¦‚ï¼Œæˆ‘ä»¬å¯ä»¥åˆ›å»ºä¸€ä¸ªåä¸º `DynamicVolumeClaim` çš„ CRDï¼Œä¸“é—¨ç”¨äºåŠ¨æ€æŒ‚è½½å­˜å‚¨å·ã€‚ä¸‹é¢æ˜¯ä¸€ä¸ªç¤ºä¾‹ï¼Œå±•ç¤ºäº†å¦‚ä½•å°† S3 å­˜å‚¨æ¡¶åŠ¨æ€æŒ‚è½½åˆ°å…·æœ‰ç‰¹å®šæ ‡ç­¾ï¼ˆä¾‹å¦‚ app=nginxï¼‰çš„ Pod ä¸­ï¼š


```yaml
apiVersion: dynamicvolume.csi.cloudnative101.net/v1alpha1
kind: DynamicVolumeClaim
metadata:
  name: dynamicvolume-s3-sample
spec:
  # ç›®æ ‡é€‰æ‹©å™¨ï¼šç²¾ç¡®åŒ¹é…éœ€è¦æŒ‚è½½å­˜å‚¨çš„å·¥ä½œè´Ÿè½½
  selector:
    matchLabels:
      app: nginx

  # å­˜å‚¨æä¾›è€…é…ç½®
  s3Config:
    bucket: my-s3-bucket
    endpoint: http://my-s3-service.example.com

  # æŒ‚è½½é…ç½®
  mountpoint: /data
  readOnly: true
```

åœ¨è¿™ä¸ªç¤ºä¾‹ä¸­ï¼š

**selector**: æŒ‡å®šäº†ç›®æ ‡ Podï¼Œå¯ä»¥é€šè¿‡æ ‡ç­¾é€‰æ‹©å™¨ç²¾å‡†åœ°åŒ¹é…éœ€è¦æŒ‚è½½å­˜å‚¨çš„ Podã€‚ä¾‹å¦‚ `app: nginx` ä¼šé€‰æ‹©æ‰€æœ‰å¸¦æœ‰ `app=nginx` æ ‡ç­¾çš„ Podã€‚

**s3Config**: æä¾›äº†è¿æ¥åˆ° S3 å­˜å‚¨æ¡¶æ‰€éœ€çš„ä¿¡æ¯ï¼ŒåŒ…æ‹¬å­˜å‚¨æ¡¶åç§°ï¼ˆ`bucket`ï¼‰å’Œ S3 æœåŠ¡çš„è®¿é—®ç«¯ç‚¹ï¼ˆ`endpoint`ï¼‰ã€‚

**mountpoint**: æŒ‡å®šäº†åœ¨ Pod å†…éƒ¨æŒ‚è½½ S3 å­˜å‚¨æ¡¶çš„è·¯å¾„ã€‚

**readOnly**: æ ‡è¯†æŒ‚è½½çš„å­˜å‚¨æ˜¯å¦ä¸ºåªè¯»ã€‚


é€šè¿‡è¿™ç§æ–¹å¼ï¼Œæˆ‘ä»¬æ— éœ€ä¿®æ”¹ Pod çš„å®šä¹‰ï¼Œå°±å¯ä»¥åŠ¨æ€åœ°ä¸ºæŒ‡å®šçš„å·¥ä½œè´Ÿè½½æŒ‚è½½å­˜å‚¨å·ï¼Œå®Œç¾å¥‘åˆäº† Kubernetes çš„å£°æ˜å¼ç®¡ç†æ¨¡å¼ã€‚

## èµ°å‘é€šç”¨åŒ–çš„è®¾è®¡

åœ¨ Kubernetes çš„ç”Ÿæ€ç³»ç»Ÿä¸­ï¼Œå­˜åœ¨å¤šç§ built-in çš„å·¥ä½œè´Ÿè½½ç±»å‹ï¼Œå¦‚ Deploymentã€StatefulSetã€DaemonSetã€Job ä»¥åŠé€šè¿‡ CRD æ‰©å±•çš„èµ„æºç­‰ç­‰ï¼Œ**å®ƒä»¬æœ€ç»ˆéƒ½ä¼šç”Ÿæˆ Pod**ã€‚è€Œæˆ‘ä»¬çš„ç›®æ ‡æ˜¯å®ç°ä¸€ç§é€šç”¨çš„åŠ¨æ€å­˜å‚¨æŒ‚è½½æ–¹æ¡ˆï¼Œé€‚ç”¨äºæ‰€æœ‰ç±»å‹çš„å·¥ä½œè´Ÿè½½ã€‚

### èšç„¦ Pod å±‚é¢

æ—¢ç„¶æ‰€æœ‰çš„å·¥ä½œè´Ÿè½½æœ€ç»ˆéƒ½ä»¥ Pod çš„å½¢å¼è¿è¡Œï¼Œé‚£ä¹ˆæˆ‘ä»¬å¯ä»¥å°† `DynamicVolumeClaim` çš„ä½œç”¨å¯¹è±¡å®šä½åœ¨ Pod å±‚é¢ã€‚é€šè¿‡åœ¨ CRD ä¸­ä½¿ç”¨é€‰æ‹©å™¨ï¼Œæˆ‘ä»¬å¯ä»¥ç²¾å‡†åœ°ä¸ºåŒ¹é…æ¡ä»¶çš„ Pod åŠ¨æ€æŒ‚è½½å­˜å‚¨å·ï¼Œè€Œæ— éœ€å…³å¿ƒå®ƒä»¬æ˜¯ç”±å“ªç§å·¥ä½œè´Ÿè½½ç±»å‹ç”Ÿæˆçš„ã€‚

#### æ€è€ƒ

è®©æˆ‘ä»¬åœä¸‹æ¥æƒ³æƒ³ï¼šå¦‚æœæˆ‘ä»¬åªå…³æ³¨ Pod å±‚é¢ï¼Œæ˜¯å¦æ„å‘³ç€æ‰€æœ‰ç±»å‹çš„å·¥ä½œè´Ÿè½½éƒ½èƒ½å˜å¾—æ›´åŠ è½»æ¾ï¼Ÿè¿™æ ·çš„è®¾è®¡æ€è·¯æ˜¯å¦èƒ½å¤Ÿå…¼é¡¾é€šç”¨æ€§å’Œæ€§èƒ½ï¼Ÿå¦‚ä½•åœ¨å¤šæ ·åŒ–çš„å·¥ä½œè´Ÿè½½ä¸­å®ç°ä¸€è‡´çš„å­˜å‚¨æŒ‚è½½ç®¡ç†ï¼Ÿ

### ä¸ç°æœ‰èµ„æºçš„åä½œ

ä¸ºäº†å®ç°ä¸ Kubernetes ç°æœ‰èµ„æºçš„è‰¯å¥½åä½œï¼Œ`DynamicVolumeClaim` åº”è¯¥éµå¾ª Kubernetes çš„ API çº¦å®šå’Œèµ„æºæ¨¡å‹ã€‚è¿™åŒ…æ‹¬ï¼š

**å…¼å®¹æ€§**ï¼šç¡®ä¿ `DynamicVolumeClaim` èƒ½å¤Ÿä¸ç°æœ‰çš„å­˜å‚¨èµ„æºï¼ˆå¦‚ PersistentVolume å’Œ PersistentVolumeClaimï¼‰ä»¥åŠå­˜å‚¨ç±»ï¼ˆStorageClassï¼‰ç­‰æ¦‚å¿µå…¼å®¹ã€‚

**æ‰©å±•æ€§**ï¼šé€šè¿‡æ”¯æŒè‡ªå®šä¹‰å‚æ•°å’Œé…ç½®ï¼Œä½¿å¾— `DynamicVolumeClaim` èƒ½å¤Ÿé€‚åº”ä¸åŒçš„å­˜å‚¨åç«¯å’Œéœ€æ±‚ï¼Œä¾‹å¦‚æ”¯æŒä¸åŒçš„äº‘å­˜å‚¨æœåŠ¡ã€æ–‡ä»¶ç³»ç»Ÿé€‰é¡¹ç­‰ã€‚

**å®‰å…¨æ€§å’Œéš”ç¦»**ï¼šè€ƒè™‘åˆ°å¤šç§Ÿæˆ·ç¯å¢ƒçš„éœ€æ±‚ï¼Œ`DynamicVolumeClaim` åº”è¯¥æä¾›è¶³å¤Ÿçš„å®‰å…¨æœºåˆ¶å’Œéš”ç¦»ç­–ç•¥ï¼Œç¡®ä¿å­˜å‚¨èµ„æºçš„è®¿é—®æ§åˆ¶å’Œæ•°æ®ä¿æŠ¤ã€‚

é€šè¿‡ä»¥ä¸Šè®¾è®¡è€ƒè™‘ï¼Œ`DynamicVolumeClaim` å¯ä»¥æˆä¸ºä¸€ä¸ªé€šç”¨çš„ã€çµæ´»çš„å­˜å‚¨ç®¡ç†è§£å†³æ–¹æ¡ˆï¼Œé€‚ç”¨äº Kubernetes ç”Ÿæ€ç³»ç»Ÿä¸­çš„å„ç§å·¥ä½œè´Ÿè½½å’Œåœºæ™¯ã€‚

### ä¸ Kubernetes åŸç”Ÿèƒ½åŠ›èåˆ

ä¸ºäº†ä½¿æˆ‘ä»¬çš„æ–¹æ¡ˆæ›´åŠ äº‘åŸç”Ÿï¼Œæˆ‘ä»¬éœ€è¦å……åˆ†åˆ©ç”¨ Kubernetes æä¾›çš„ç‰¹æ€§ã€‚ä¾‹å¦‚ï¼š

**Mount Propagation**ï¼šåˆ©ç”¨æŒ‚è½½ä¼ æ’­ç‰¹æ€§ï¼Œå®ç°å®¹å™¨ä¹‹é—´ä»¥åŠå®¹å™¨ä¸å®¿ä¸»æœºä¹‹é—´çš„æŒ‚è½½å…±äº«ã€‚

**Operator æ¨¡å¼**ï¼šé€šè¿‡ç¼–å†™è‡ªå®šä¹‰çš„ Controllerï¼Œç›‘å¬ `DynamicVolumeClaim` èµ„æºçš„å˜åŒ–ï¼Œè‡ªåŠ¨æ‰§è¡ŒæŒ‚è½½å’Œå¸è½½æ“ä½œã€‚

## å¦‚ä½•è®¾è®¡æŒ‚è½½ç‚¹

æŒ‚è½½ç‚¹æ˜¯å­˜å‚¨èµ„æºä¸å®¹å™¨äº¤äº’çš„å…³é”®æ¥å£ã€‚é€šè¿‡é¢„è®¾çš„æŒ‚è½½ç‚¹ï¼Œæˆ‘ä»¬å¯ä»¥ç¡®ä¿å­˜å‚¨çš„å˜åŒ–èƒ½å¤ŸåŠæ—¶ã€å‡†ç¡®åœ°ä¼ æ’­åˆ°éœ€è¦çš„å®¹å™¨ä¸­ï¼Œå®ç°åŠ¨æ€æŒ‚è½½çš„ç›®çš„ã€‚


æŒ‚è½½ç‚¹çš„è®¾è®¡æ˜¯å®ç°åŠ¨æ€æŒ‚è½½çš„å…³é”®ã€‚åœ¨ä¸šç•Œï¼Œå¸¸è§çš„åšæ³•æœ‰ä¸¤ç§ï¼š

**Sidecar æ¨¡å¼**ï¼šåœ¨åŒä¸€ä¸ª Pod å†…ï¼Œé€šè¿‡å…±äº« Volume çš„æ–¹å¼ï¼Œè®©ä¸»å®¹å™¨å’Œ Sidecar å®¹å™¨å…±äº«åŒä¸€ä¸ªå­˜å‚¨å·ã€‚è¿™æ ·ï¼ŒSidecar å®¹å™¨å¯ä»¥è´Ÿè´£æŒ‚è½½å’Œç®¡ç†å­˜å‚¨èµ„æºï¼Œä¸»å®¹å™¨åˆ™ç›´æ¥ä½¿ç”¨ã€‚
    
1. ä¼˜ç‚¹ï¼šPod å†…å…±äº«å­˜å‚¨ï¼Œç®¡ç†ç®€å•ã€‚
2. ç¼ºç‚¹ï¼šé¢å¤–çš„å®¹å™¨èµ„æºå¼€é”€
   
**HostPath å…±äº«**ï¼šé€šè¿‡åœ¨åŒä¸€ä¸ªèŠ‚ç‚¹ä¸Šçš„ç¬¬ä¸‰æ–¹ Podï¼Œåˆ©ç”¨ HostPath ç›®å½•ä½œä¸ºæŒ‚è½½ç‚¹ï¼Œé€šè¿‡ Mount Propagation å®ç°æŒ‚è½½çš„ä¼ æ’­ã€‚
    
1. ä¼˜ç‚¹ï¼šè·¨ Pod é«˜æ•ˆå…±äº«
2. ç¼ºç‚¹ï¼šéœ€è¦ç²¾ç¡®çš„æƒé™æ§åˆ¶

åŠ¨æ€æŒ‚è½½å·çš„å·¥ä½œåŸç†å…¶å®ä¹Ÿéå¸¸ç®€å•ï¼Œå½’æ ¹ç»“åº•ä¹Ÿæ˜¯é€šè¿‡ä¸€ä¸ªé¢„è®¾çš„æŒ‚è½½ç‚¹æ¥ä¼ æ’­å­˜å‚¨ï¼Œæˆ‘ä»¬é€‰æ‹©äº†åŸºäº Mount Propagation çš„æ–¹æ¡ˆï¼Œå…¼é¡¾äº†æ€§èƒ½å’Œçµæ´»æ€§ã€‚

æ€è€ƒä¸€ä¸‹ï¼šé€‰æ‹© Sidecar æ¨¡å¼è¿˜æ˜¯ HostPath å…±äº«æ¨¡å¼ï¼Œå“ªç§æ–¹å¼æ›´é€‚åˆä½ çš„åœºæ™¯ï¼Ÿä¸åŒçš„åº”ç”¨åœºæ™¯å¯èƒ½ä¼šæœ‰ä¸åŒçš„ç­”æ¡ˆã€‚

## æŠ€æœ¯æ¶æ„ï¼šé€šç”¨åŠ¨æ€æŒ‚è½½æ–¹æ¡ˆ

ä¸ºäº†è®©å¤§å®¶æ›´æ¸…æ™°åœ°ç†è§£ï¼Œæˆ‘ä»¬æ¥çœ‹ä¸€ä¸‹å…·ä½“çš„å®ç°ã€‚

### åŠ¨æ€å· CSI Driver

æˆ‘ä»¬å¯ä»¥å¼€å‘ä¸€ä¸ªåä¸º **Dynamic Volume CSI Driver** çš„ç»„ä»¶ï¼Œåˆ©ç”¨ [Container Storage Interface (CSI)](https://kubernetes-csi.github.io/docs/) çš„ Inline Volume ç‰¹æ€§ï¼Œå°†åŠ¨æ€æŒ‚è½½åŠŸèƒ½ä¸ Kubernetes ç´§å¯†é›†æˆï¼Œä¸ºå·¥ä½œè´Ÿè½½æä¾›é€šç”¨çš„åŠ¨æ€å­˜å‚¨æŒ‚è½½èƒ½åŠ›ã€‚

> æˆ‘ä¸ºä»€ä¹ˆä½¿ç”¨ CSI Driver æ¥åšåŠ¨æ€æŒ‚è½½å‘¢ï¼Ÿè®¾è®¡çµæ„Ÿæ¥æºäº [Secrets Store CSI Driver](https://github.com/kubernetes-sigs/secrets-store-csi-driver) è¿™ä¸ªé¡¹ç›®ï¼Œæ„Ÿå…´è¶£çš„è¯»è€…å¯ä»¥é˜…è¯»ä¸€ä¸‹ã€‚


### å·¥ä½œåŸç†

å¦‚ä¸‹å›¾æ‰€ç¤ºï¼Œæ–¹æ¡ˆä¸»è¦ç”± **CSI Node Serviceï¼ˆDaemonSetï¼‰** å’Œ **Dynamic Mount Podï¼ˆDMPï¼‰** ç»„æˆã€‚


![architecuure](https://cdn.jsdelivr.net/gh/cloud-native-101/files@main/imgs/kubernetes-storage-101-dynamic-volume-mounting-runtime-flexibility/architecture-1.jpg)

##### CSI Node Service

ä¸»è¦è´Ÿè´£å¤„ç†ç”¨æˆ·çš„åŠ¨æ€æŒ‚è½½è¯·æ±‚ï¼Œä»¥åŠç®¡ç† Dynamic Mount Podï¼ˆDMPï¼‰çš„ç”Ÿå‘½å‘¨æœŸã€‚å®ƒå®ç°äº† CSI çš„ Ephemeral Inline Volume èƒ½åŠ›ï¼ŒåŒæ—¶åŒ…å«ä¸‰ä¸ªæ§åˆ¶å™¨æ¥å®Œæˆæ§åˆ¶é¢çš„ä»»åŠ¡ã€‚

###### **æ§åˆ¶å™¨ç»„ä»¶**ï¼š

**Storage Provider Class Controller**ï¼šç®¡ç†å­˜å‚¨æä¾›è€…çš„é…ç½®ï¼Œé˜²æ­¢èµ„æºè¢«éšæ„åˆ é™¤ã€‚

**External Volume Controller**ï¼šç›‘å¬ `DynamicVolumeClaim` èµ„æºçš„åˆ›å»ºå’Œåˆ é™¤ï¼Œæ ¹æ®ä¸åŒçš„ `Storage Provider` åˆ›å»ºæˆ–é”€æ¯ DMPï¼Œä»¥åŠæ¢å¤å¼‚å¸¸å…³é—­çš„ Dynamic Mount Podã€‚

**Dynamic Mount Pod Controller**ï¼šç›‘å¬å½“å‰èŠ‚ç‚¹æ‰€åœ¨çš„ DMPï¼Œå½“æ‰€æœ‰æŒ‚è½½éƒ½ä¸å­˜åœ¨æ—¶ï¼Œé‡Šæ”¾ DMP åŠç›¸å…³èµ„æºã€‚

##### Dynamic Mount Pod

- å®é™…æ‰§è¡ŒæŒ‚è½½æ“ä½œçš„ Podã€‚
- é€šè¿‡ Informer ç›‘å¬ Pod çš„å˜åŒ–ï¼ˆDynamicVolumeClaim CR çš„å¢åŠ æˆ–è€…åˆ é™¤è¡Œä¸ºï¼Œå®ƒä¼šåŒæ­¥åæ˜ åˆ° DMP çš„ annotation ä¸­ï¼‰
- åœ¨ `/xvols` ç›®å½•ä¸‹æ‰§è¡Œå­˜å‚¨çš„æŒ‚è½½æˆ–å¸è½½æ“ä½œã€‚

##### æ€è€ƒ

ä½ å¯èƒ½ä¼šé—®ï¼šä¸ºä»€ä¹ˆä¸ç›´æ¥å°†æŒ‚è½½ç‚¹è®¾ç½®ä¸ºå®¿ä¸»æœºç›®å½•ï¼Ÿè™½ç„¶è¿™æ ·å®ç°èµ·æ¥ç®€å•ï¼Œä½†é£é™©å·¨å¤§ï¼Œå°¤å…¶åœ¨èŠ‚ç‚¹æ•…éšœæ—¶ï¼Œçˆ†ç‚¸åŠå¾„ä¼šå¾ˆå¤§ï¼Œå½±å“æ•´ä¸ªèŠ‚ç‚¹ä¸‹çš„ç”¨æˆ·å®ä¾‹ã€‚è¿™ä¹Ÿæ˜¯æˆ‘ä»¬å¿…é¡»è°¨æ…è€ƒè™‘çš„æ–¹é¢ã€‚

### Diagram  

é€šç”¨åŠ¨æ€æŒ‚è½½å·çš„æ ¸å¿ƒåŠŸèƒ½å……åˆ†åˆ©ç”¨äº† Kubernetes æä¾›çš„ Mount Propagationï¼ˆæŒ‚è½½ä¼ æ’­ï¼‰èƒ½åŠ›ï¼Œåœ¨ DMP å†…å®ç°å¯¹å­˜å‚¨å·çš„åŠ¨æ€æŒ‚è½½ã€‚ä¸‹é¢çš„å›¾ç¤ºè¯¦ç»†å±•ç¤ºäº†ç”¨æˆ· Pod å†…å®ç°åŠ¨æ€æŒ‚è½½å·çš„è¿‡ç¨‹ï¼Œå¹¶é˜è¿°äº†ä¸ä¹‹ç›¸å…³çš„ Mount Propagation ç»„ä»¶ã€‚


![architecuure](https://cdn.jsdelivr.net/gh/cloud-native-101/files@main/imgs/kubernetes-storage-101-dynamic-volume-mounting-runtime-flexibility/diagram.jpg)

**æ­¥éª¤ 1**: ç”¨æˆ·åˆ›å»º Podã€‚åœ¨ Pod çš„ annotation ä¸­ï¼Œç”¨æˆ·éœ€è¦æŒ‡å®šé¢„å…ˆåˆ›å»ºå¥½çš„ StorageProviderClassï¼ˆå¦‚ `s3`ï¼‰å’Œ volumeMountPathRootï¼ˆå¦‚ `/user-defined-root-path`ï¼‰ã€‚

**æ­¥éª¤ 2**: åœ¨ Pod åˆå§‹åŒ–é˜¶æ®µï¼ŒMutating Webhook å°†ä¸€ä¸ª `Ephemeral Inline Volume` æ³¨å…¥åˆ°ç”¨æˆ·çš„ Podã€‚

**æ­¥éª¤ 3**: CSI Node Service åˆ©ç”¨ K8s CSI Inline Volume ç‰¹æ€§ï¼Œå°† Pod å†…çš„ `/user-defined-root-path` ç›®å½•ä¸å®¿ä¸»æœºçš„æŸä¸€ç‰¹å®šç›®å½•è¿›è¡Œæ˜ å°„ï¼Œè·¯å¾„å¦‚ä¸‹ï¼š`/var/lib/kubelet/pods/<POD-ID>/volumes/kubernetes.io~csi/<PV-NAME>/mount`ã€‚

**æ­¥éª¤ 4**: åœ¨ NodePublishVolume é˜¶æ®µç»“æŸæ—¶ï¼ŒCSI Node Service ä¼šä¸ºè¯¥ Pod åœ¨å½“å‰å®¿ä¸»æœºä¸Šåˆ†é…ä¸€ä¸ªä¸“å±ç›®å½•ã€‚æ­¤ç›®å½•è·¯å¾„å¦‚ï¼š`/var/lib/dynamic/xvols/<storage-provider-class>/<uuid>`ã€‚æ¥ä¸‹æ¥ï¼Œè¯¥ç›®å½•ä¸‹çš„å·¥ä½œè´Ÿè½½ UID ç›®å½•ä¸å‰è¿°çš„æ˜ å°„è·¯å¾„è¿›è¡Œç»‘å®šï¼Œç¡®ä¿ä»»ä½•å¯¹æ­¤ç›®å½•çš„ä¿®æ”¹éƒ½ä¼šåŒæ­¥è‡³ `/user-defined-root-path`ã€‚

**æ­¥éª¤ 5**: Kubelet å¯åŠ¨ç”¨æˆ· Podã€‚

**æ­¥éª¤ 6**: å½“ç”¨æˆ·å‘é€åŠ¨æ€æŒ‚è½½è¯·æ±‚ï¼ˆå³åˆ›å»ºä¸€ä¸ª DynamicVolumeClaimï¼ˆCRï¼‰ï¼‰æ—¶ï¼ŒCSI Node Service å°†åœ¨å¯¹åº”èŠ‚ç‚¹ä¸Šç”Ÿæˆä¸€ä¸ª `DMP`ã€‚è¿™ä¸ª `DMP` å®¹å™¨çš„ `/xvols` ç›®å½•è¢«æŒ‚è½½åˆ°äº†æ­¥éª¤ 4 åˆ†é…çš„ä¸“å±ç›®å½• `/var/lib/dynamic/xvols/<storage-privider-class>/<uuid>/<podUID>`ï¼Œå¹¶ç¡®ä¿å®ƒä»¬ä¹‹é—´çš„ä¼ æ’­ç­–ç•¥è®¾ç½®ä¸º `Bidirectional`ã€‚

**æ­¥éª¤ 7**: DMP çš„ Informer è´Ÿè´£ç›‘å¬è¯·æ±‚å˜åŠ¨ï¼Œå¹¶åœ¨å…¶ `/xvols` ç›®å½•ä¸­æ‰§è¡Œå¤–éƒ¨å­˜å‚¨çš„æŒ‚è½½æˆ–å¸è½½ã€‚è¿™æ ·ï¼Œ`/xvols` ä¸‹çš„æ‰€æœ‰å˜æ›´éƒ½ä¼šå®æ—¶åŒæ­¥åˆ°ç”¨æˆ· Pod çš„ `/user-defined-root-path` ç›®å½•ã€‚

è¿™ä¸ªæµç¨‹ä½¿ç”¨æˆ·èƒ½å¤Ÿåœ¨å…¶ Pod å†…å®ç°åŠ¨æ€æŒ‚è½½å·ï¼Œå……åˆ†åˆ©ç”¨äº† Kubernetes æä¾›çš„ Mount Propagation èƒ½åŠ›ï¼Œå®ç°äº†å­˜å‚¨çš„é«˜åº¦çµæ´»æ€§å’Œå¯è®¿é—®æ€§ã€‚

### Concepts

æˆ‘ä»¬çš„ Operator æä¾›äº† 2 ä¸ª CRD æ¥ç®¡ç†åŠ¨æ€æŒ‚è½½å·ã€‚

#### 1. StorageProviderClass

> å®šä¹‰äº†ä¸å¤–éƒ¨æŒ‚è½½å­˜å‚¨çš„è¿æ¥è¯¦ç»†ä¿¡æ¯


`StorageProviderClass` æ˜¯ Dynamic Volume CSI é©±åŠ¨ç¨‹åºä¸­**é›†ç¾¤çº§åˆ«**çš„èµ„æºï¼Œç”¨äºå‘ CSI é©±åŠ¨ç¨‹åºæä¾›å®šä¹‰äº†ä¸å¤–éƒ¨æŒ‚è½½å­˜å‚¨çš„è¿æ¥è¯¦ç»†ä¿¡æ¯çš„èƒ½åŠ›ã€‚

ä¸‹é¢æ˜¯ StorageProviderClass èµ„æºçš„ç¤ºä¾‹ï¼š

```yaml
apiVersion: v1
metadata:
  name: provider-s3-secret
  namespace: default
kind: Secret
type: Opaque
stringData:
  access-key-id: cldevaccesskey
  secret-access-key: cldevsecretkey
---
apiVersion: dynamicvolume.csi.cloudnative101.net/v1alpha1
kind: StorageProviderClass
metadata:
  name: s3-sample
spec:
  provider: s3
  parameters:
    # å®‰å…¨åœ°å¼•ç”¨ Secret
    dynamicvolume.csi.cloudnative101.net/storage-provider-secret-name: provider-s3-secret
    dynamicvolume.csi.cloudnative101.net/storage-provider-secret-namespace: default

    # èµ„æºé…ç½®ï¼ˆå¯é€‰ï¼‰
    dynamicvolume.csi.cloudnative101.net/mount-cpu-request: 10m
    dynamicvolume.csi.cloudnative101.net/mount-memory-request: 50Mi
    dynamicvolume.csi.cloudnative101.net/mount-cpu-limit: 10m
    dynamicvolume.csi.cloudnative101.net/mount-memory-limit: 50Mi
```

Mutating Webhook å°†è‡ªåŠ¨ä¸ºå¼•ç”¨ StorageProviderClass çš„ Pod å·è¿›è¡Œé…ç½®ï¼š

```yaml
volumes:
- csi:
    driver: dynamicvolume.csi.cloudnative101.net
    readOnly: true
    volumeAttributes:
      mountPodDispatchPolicy: independent
      storageProviderClass: s3-sample
  name: dynamic-volume-root-path
```

âš ï¸ åœ¨ CRD é‡Œï¼Œä¸å»ºè®®ç›´æ¥å°†æ•æ„Ÿä¿¡æ¯å®šä¹‰åœ¨ spec ä¸­ï¼Œé€šå¸¸çš„åšæ³•æ˜¯åœ¨ CRD çš„ `spec` ä¸­å¼•ç”¨ä¸€ä¸ªå¤–éƒ¨å®šä¹‰çš„ Secretï¼Œä»¥ç¡®ä¿å®‰å…¨æ€§å’Œå¯ç»´æŠ¤æ€§ã€‚

#### 2. DynamicVolumeClaim

>  å®šä¹‰äº†ç›®æ ‡å·¥ä½œè´Ÿè½½éœ€è¦æŒ‚è½½çš„å¤–éƒ¨å­˜å‚¨å·ä¿¡æ¯ä»¥åŠæŒ‚è½½åçš„æƒ…å†µ

`DynamicVolumeClaim` æ˜¯ Dynamic Volume CSI é©±åŠ¨ç¨‹åºä¸­**å‘½åç©ºé—´çº§åˆ«**çš„èµ„æºï¼Œç”¨äºå‘ CSI é©±åŠ¨ç¨‹åºæä¾›å®šä¹‰äº†ç›®æ ‡å·¥ä½œè´Ÿè½½éœ€è¦æŒ‚è½½çš„å¤–éƒ¨å­˜å‚¨å·ä¿¡æ¯ä»¥åŠæŒ‚è½½åçš„æƒ…å†µï¼ŒåŒæ—¶ç”¨æ¥è·Ÿè¸ªåŒ¹é…çš„ `Dynamic Mount Pod`ã€‚

ä¸‹é¢æ˜¯ DynamicVolumeClaim èµ„æºçš„ç¤ºä¾‹ï¼š

```yaml
apiVersion: dynamicvolume.csi.cloudnative101.net/v1alpha1
kind: DynamicVolumeClaim
metadata:
  name: externalvolume-s3-sample
  namespace: dynamic-volume-test
spec:
  # æŒ‚è½½ç‚¹é…ç½®
  mountpoint: /data
  # S3 å­˜å‚¨ç‰¹å®šé…ç½®
  s3Config:
    bucket: ssat202410181
    endpoint: https://play.min.io
  # ç›®æ ‡å·¥ä½œè´Ÿè½½é€‰æ‹©å™¨
  selector:
    matchLabels:
      app: app-4-s3
  # å­˜å‚¨æä¾›è€…
  storageProvider: s3
```

ğŸ’¡ **å°è´´å£«**ï¼šå¤§å®¶å¯ä»¥é€šè¿‡ä¸‹é¢çš„ç»ˆç«¯æ“ä½œå½•å±ï¼Œè·å–è¯¦ç»†æ­¥éª¤çš„ç›´è§‚æ¼”ç¤ºï¼š

<script src="https://asciinema.org/a/692437.js" id="asciicast-692437" async="true"></script>


ä»¥ä¸Šæ˜¯åŠ¨æ€æŒ‚è½½é¡¹ç›®çš„ä¸€ä¸ªç²—ç•¥ä»‹ç»ï¼Œé¡¹ç›®æ·±ç©¶è¿˜æœ‰è¯¸å¤šç»†èŠ‚å€¼å¾—æ¢è®¨ğŸ’¡ 

ğŸ” **å¦‚ä½•èµ‹äºˆå·¥ä½œè´Ÿè½½åŠ¨æ€æŒ‚è½½å·çš„èƒ½åŠ›ï¼Ÿ**

æ€è€ƒæ–¹å‘ï¼š
* æ˜¯é€šè¿‡ namespace çº§åˆ«å…¨å±€æ³¨å…¥ï¼Ÿ
* è¿˜æ˜¯ç›´æ¥åœ¨å·¥ä½œè´Ÿè½½ä¸Šè¿›è¡Œé…ç½®ï¼Ÿ

ğŸ§ **å…³é”®æŠ€æœ¯ç‚¹ï¼š**
* Dynamic Volume CSI é©±åŠ¨ç¨‹åºçš„è°ƒåº¦ç­–ç•¥
* ç”¨æˆ· Pod æ„å¤–é‡å¯çš„å¤„ç†æœºåˆ¶
* DMP æ„å¤–é‡å¯çš„åº”å¯¹æ–¹æ¡ˆ

æ¬¢è¿å¯¹åŠ¨æ€å­˜å‚¨æŒ‚è½½æ„Ÿå…´è¶£çš„æŠ€æœ¯çˆ±å¥½è€… ğŸ¤ ä¸€èµ·äº¤æµæ¢è®¨ï¼


## å†™åœ¨æœ€å

æœ¬æ–¹æ¡ˆé€šè¿‡ Operator æ¨¡å¼å’Œ CSI Driverï¼Œå®ç°äº† Kubernetes å­˜å‚¨ç®¡ç†çš„æ–°èŒƒå¼ã€‚å®ƒä¸ä»…æä¾›äº†åŠ¨æ€ã€çµæ´»çš„å­˜å‚¨æŒ‚è½½èƒ½åŠ›ï¼Œè¿˜ç§‰æ‰¿äº†äº‘åŸç”Ÿçš„è®¾è®¡ç†å¿µã€‚å¸Œæœ›è¿™ä¸€æ€è·¯èƒ½ä¸ºå¤§å®¶åœ¨äº‘åŸç”Ÿç¯å¢ƒä¸‹çš„å­˜å‚¨ç®¡ç†æä¾›æ–°çš„å¯å‘ã€‚
